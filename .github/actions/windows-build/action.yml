inputs:
  config:
    required: true
    type: string

runs:
  using: "composite"

  steps:
  - name: Configure VC++ build for amd64
    uses: compnerd/gha-setup-vsdevenv@main
    with:
      arch: amd64

  - name: Install the Swift Toolset
    uses: compnerd/gha-setup-swift@main
    with:
      branch: development
      tag: DEVELOPMENT-SNAPSHOT-2023-07-04-a

  - name: Configure CMake
    shell: cmd
    run: cmake --preset ${{ inputs.config }}

  - name: Build
    shell: cmd
    run: |
      cmake --build --preset ${{ inputs.config }}
      cmake --build --preset ${{ inputs.config }} --target install

  - name: Validate Checked-In Files are Up-To-Date
    shell: powershell
    run: |
      $dirty = git status --porcelain
      if ($dirty) {
        git diff
        throw "Checked in files are not up-to-date, re-run swiftwinrt before checking-in: \n$dirty"
      }
      
  - name: Run test app
    shell: cmd
    run: .\out\${{ inputs.config }}\bin\test_app.exe
